<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RPGMZ Player (Pro) - æ”¯æŒæœ¬åœ°å’Œåœ¨çº¿éƒ¨ç½²</title>
  <style>
    body { 
      font-family: "Segoe UI", "Microsoft YaHei", sans-serif; 
      background: #1e1e1e; 
      color: #eee; 
      margin: 0; 
      height: 100vh; 
      display: flex; 
      flex-direction: column; 
      overflow: hidden; 
    }
    
    header { 
      padding: 10px 20px; 
      background: #252526; 
      border-bottom: 1px solid #333; 
      display: flex; 
      align-items: center; 
      gap: 15px; 
      flex-wrap: wrap;
    }
    
    .container { 
      display: flex; 
      flex: 1; 
      height: calc(100vh - 60px); 
      overflow: hidden;
    }
    
    .game-area { 
      flex: 3; 
      background: #000; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      position: relative; 
      min-width: 0;
    }
    
    iframe { 
      width: 100%; 
      height: 100%; 
      border: none; 
      background: #000;
    }
    
    .sidebar { 
      flex: 1; 
      min-width: 300px; 
      max-width: 400px; 
      background: #252526; 
      border-left: 1px solid #333; 
      display: flex; 
      flex-direction: column; 
      padding: 15px; 
      gap: 15px; 
      overflow-y: auto; 
    }
    
    .panel { 
      background: #333; 
      padding: 15px; 
      border-radius: 8px; 
      border: 1px solid #444;
    }
    
    .panel h3 { 
      margin-top: 0; 
      margin-bottom: 10px; 
      font-size: 14px; 
      color: #aaa; 
      text-transform: uppercase; 
      letter-spacing: 1px;
    }
    
    textarea#game-text { 
      width: 100%; 
      height: 150px; 
      background: #1e1e1e; 
      color: #fff; 
      border: 1px solid #444; 
      padding: 10px; 
      font-size: 14px; 
      resize: vertical; 
      box-sizing: border-box; 
      border-radius: 4px;
      font-family: "Consolas", "Monaco", monospace;
      line-height: 1.4;
    }
    
    #screenshot-img { 
      max-width: 100%; 
      border: 1px solid #555; 
      display: none; 
      margin-top: 5px; 
      border-radius: 4px;
    }
    
    button { 
      background: #0e639c; 
      color: white; 
      border: none; 
      padding: 10px 15px; 
      cursor: pointer; 
      border-radius: 4px; 
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    button:hover { 
      background: #1177bb; 
    }
    
    button.secondary { 
      background: #444; 
    }
    
    button.secondary:hover { 
      background: #555; 
    }
    
    #log { 
      font-family: "Consolas", "Monaco", monospace; 
      font-size: 12px; 
      color: #888; 
      margin-top: auto; 
      white-space: pre-wrap; 
      min-height: 100px; 
      background: #1e1e1e; 
      padding: 10px; 
      border-radius: 4px; 
      border: 1px solid #333;
      max-height: 200px;
      overflow-y: auto;
    }
    
    /* æˆªå›¾é—ªå…‰ç‰¹æ•ˆ */
    #flash { 
      position: absolute; 
      top:0; 
      left:0; 
      width:100%; 
      height:100%; 
      background:white; 
      opacity:0; 
      pointer-events:none; 
      transition: opacity 0.2s; 
      z-index: 1000;
    }
    
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .checkbox-container input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }
    
    .status-bar {
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }
    
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #888;
    }
    
    .status-indicator.active {
      background: #4CAF50;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .controls-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    
    #debug-info {
      font-size: 11px;
      color: #666;
      padding: 5px;
      background: #1a1a1a;
      border-radius: 3px;
      margin-top: 5px;
    }
  </style>
</head>
<body>

<header>
  <h3 style="margin: 0;">ğŸ® RPGMZ Player Pro</h3>
  <input type="file" id="zip" accept=".zip,.ZIP" />
  <div class="status-bar">
    <span id="sw-status">Service Worker: <span class="status-indicator" id="sw-indicator"></span></span>
    <span id="game-status">æ¸¸æˆ: <span class="status-indicator" id="game-indicator"></span></span>
    <span id="env-info"></span>
  </div>
</header>

<div class="container">
  <div class="game-area">
    <iframe id="game" sandbox="allow-same-origin allow-scripts allow-popups allow-forms"></iframe>
    <div id="flash"></div>
  </div>

  <div class="sidebar">
    <div class="panel">
      <h3>ğŸ’¬ å¯¹è¯æ–‡æœ¬æå–</h3>
      <div class="controls-row">
        <div class="checkbox-container">
          <input type="checkbox" id="auto-sync" checked>
          <label for="auto-sync">è‡ªåŠ¨åŒæ­¥</label>
        </div>
        <button class="secondary" onclick="extractText()" title="æ‰‹åŠ¨æå–å½“å‰å¯¹è¯">
          ğŸ“ æ‰‹åŠ¨æå–
        </button>
        <button class="secondary" onclick="clearText()" title="æ¸…ç©ºæ–‡æœ¬æ¡†">
          ğŸ—‘ï¸ æ¸…ç©º
        </button>
      </div>
      <textarea id="game-text" placeholder="å½“å‰æ²¡æœ‰å¯¹è¯..."></textarea>
    </div>

    <div class="panel">
      <h3>ğŸ“· æˆªå›¾åŠŸèƒ½</h3>
      <div class="controls-row">
        <button onclick="takeScreenshot()" title="æˆªå–æ¸¸æˆç”»é¢">
          ğŸ“¸ æˆªå–ç”»é¢
        </button>
        <button class="secondary" onclick="downloadScreenshot()" title="ä¸‹è½½æˆªå›¾" id="download-btn" disabled>
          â¬‡ï¸ ä¸‹è½½æˆªå›¾
        </button>
      </div>
      <img id="screenshot-img" />
      <p id="screenshot-tip" style="font-size:12px; color:#888; display:none; margin: 5px 0 0 0;">
        å·²æ•è· (å³é”®å¯ä¿å­˜)
      </p>
    </div>

    <div class="panel">
      <h3>âš™ï¸ è°ƒè¯•ä¿¡æ¯</h3>
      <div id="debug-info">ç­‰å¾…åŠ è½½...</div>
    </div>

    <div id="log">ç­‰å¾… ZIP æ–‡ä»¶ä¸Šä¼ ...</div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
// ============================
// å…¨å±€å˜é‡
// ============================
let lastText = "";
let textInterval;
let currentScreenshot = null;

// DOM å…ƒç´ å¼•ç”¨
let swIndicator, gameIndicator, swStatusText, gameStatusText, envInfo;

// ============================
// æ—¥å¿—ç³»ç»Ÿ
// ============================
const log = (t) => {
  try {
    const el = document.getElementById("log");
    if (el) {
      const timestamp = new Date().toLocaleTimeString();
      el.textContent = `[${timestamp}] ${t}\n${el.textContent}`;
      // é™åˆ¶æ—¥å¿—è¡Œæ•°
      const lines = el.textContent.split('\n');
      if (lines.length > 50) {
        el.textContent = lines.slice(0, 50).join('\n');
      }
    }
  } catch (error) {
    console.warn('æ—¥å¿—è®°å½•å¤±è´¥:', error);
  }
};

// ============================
// DOM å·¥å…·å‡½æ•°
// ============================

// å®‰å…¨çš„ DOM å…ƒç´ è·å–å‡½æ•°
function getElementSafe(id) {
  const el = document.getElementById(id);
  if (!el) {
    console.warn(`å…ƒç´  ${id} æœªæ‰¾åˆ°`);
    return {
      className: '',
      style: { background: '', animation: '' },
      textContent: '',
      innerHTML: '',
      disabled: false,
      value: ''
    };
  }
  return el;
}

// åˆå§‹åŒ– DOM å¼•ç”¨
function initDOMElements() {
  swIndicator = getElementSafe('sw-indicator');
  gameIndicator = getElementSafe('game-indicator');
  swStatusText = getElementSafe('sw-status');
  gameStatusText = getElementSafe('game-status');
  envInfo = getElementSafe('env-info');
  
  // æ›´æ–°ç¯å¢ƒä¿¡æ¯æ˜¾ç¤º
  if (envInfo && envInfo.textContent !== undefined) {
    const isGitHubPages = window.location.hostname.includes('github.io');
    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    envInfo.textContent = isGitHubPages ? 'ğŸŒ GitHub Pages' : isLocalhost ? 'ğŸ’» æœ¬åœ°ç¯å¢ƒ' : 'ğŸŒ åœ¨çº¿ç¯å¢ƒ';
  }
}

// ============================
// çŠ¶æ€ç®¡ç†
// ============================

// æ›´æ–° Service Worker çŠ¶æ€æŒ‡ç¤ºå™¨
function updateSWStatus(status) {
  try {
    switch(status) {
      case 'registered':
        swIndicator.className = 'status-indicator active';
        swStatusText.textContent = 'Service Worker: å·²æ¿€æ´»';
        break;
      case 'error':
        swIndicator.style.background = '#f44336';
        swIndicator.style.animation = '';
        swStatusText.textContent = 'Service Worker: é”™è¯¯';
        break;
      case 'installing':
        swIndicator.style.background = '#ff9800';
        swIndicator.style.animation = 'pulse 1s infinite';
        swStatusText.textContent = 'Service Worker: å®‰è£…ä¸­';
        break;
      default:
        swIndicator.style.background = '#888';
        swIndicator.style.animation = '';
        swStatusText.textContent = 'Service Worker: æœªæ³¨å†Œ';
    }
  } catch (error) {
    console.warn('æ›´æ–° SW çŠ¶æ€æ—¶å‡ºé”™:', error);
  }
}

// æ›´æ–°æ¸¸æˆçŠ¶æ€
function updateGameStatus(status) {
  try {
    switch(status) {
      case 'loaded':
        gameIndicator.className = 'status-indicator active';
        gameStatusText.textContent = 'æ¸¸æˆ: å·²åŠ è½½';
        break;
      case 'loading':
        gameIndicator.style.background = '#ff9800';
        gameIndicator.style.animation = 'pulse 1s infinite';
        gameStatusText.textContent = 'æ¸¸æˆ: åŠ è½½ä¸­';
        break;
      case 'error':
        gameIndicator.style.background = '#f44336';
        gameIndicator.style.animation = '';
        gameStatusText.textContent = 'æ¸¸æˆ: é”™è¯¯';
        break;
      default:
        gameIndicator.style.background = '#888';
        gameIndicator.style.animation = '';
        gameStatusText.textContent = 'æ¸¸æˆ: æœªåŠ è½½';
    }
  } catch (error) {
    console.warn('æ›´æ–°æ¸¸æˆçŠ¶æ€æ—¶å‡ºé”™:', error);
  }
}

// ============================
// ç¯å¢ƒæ£€æµ‹å’Œè·¯å¾„å¤„ç†
// ============================
function getBasePath() {
  // GitHub Pages ç‰¹æ®Šå¤„ç†
  if (window.location.hostname.includes('github.io')) {
    const pathSegments = window.location.pathname.split('/');
    // è¿‡æ»¤æ‰ç©ºå­—ç¬¦ä¸²å’Œæ–‡ä»¶æ‰©å±•å
    const filteredSegments = pathSegments.filter(segment => 
      segment && !segment.includes('.') && segment !== 'index.html'
    );
    
    if (filteredSegments.length > 0) {
      // è¿”å›å¸¦æ–œæ çš„è·¯å¾„
      return '/' + filteredSegments.join('/') + '/';
    } else {
      return '/';
    }
  }
  
  // æœ¬åœ°å¼€å‘ç¯å¢ƒ
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    return '/';
  }
  
  // é»˜è®¤æƒ…å†µ
  return '/';
}

const BASE_PATH = getBasePath();

// è·å–æ­£ç¡®çš„ Service Worker è·¯å¾„
function getSWPath() {
  if (BASE_PATH === '/') {
    return 'sw.js';
  } else {
    // ç¡®ä¿è·¯å¾„æ­£ç¡®
    return BASE_PATH.replace(/\/+$/, '') + '/sw.js';
  }
}

// è·å–æ­£ç¡®çš„æ¸¸æˆè·¯å¾„
function getGamePath() {
  if (BASE_PATH === '/') {
    return '/game/index.html';
  } else {
    // ç¡®ä¿è·¯å¾„æ­£ç¡®
    return BASE_PATH.replace(/\/+$/, '') + '/game/index.html';
  }
}

// ============================
// Service Worker æ³¨å†Œä¸é€šä¿¡
// ============================

// Service Worker æ¶ˆæ¯å¤„ç†
function setupSWMessageHandler() {
  try {
    navigator.serviceWorker.addEventListener("message", (event) => {
      if (event.data && event.data.type === "GAME_READY") {
        log("âœ… èµ„æºå°±ç»ªï¼Œå¯åŠ¨æ¸¸æˆ...");
        updateGameStatus('loading');
        
        const gameUrl = getGamePath();
        log(`ğŸš€ åŠ è½½æ¸¸æˆ: ${gameUrl}`);
        
        const iframe = document.getElementById("game");
        if (iframe) {
          iframe.src = gameUrl;
          
          // ç›‘å¬ iframe åŠ è½½å®Œæˆ
          iframe.onload = function() {
            log("ğŸ® æ¸¸æˆåŠ è½½å®Œæˆ");
            updateGameStatus('loaded');
            startTextWatcher();
          };
          
          iframe.onerror = function() {
            log("âŒ æ¸¸æˆåŠ è½½å¤±è´¥");
            updateGameStatus('error');
          };
        }
      }
      
      if (event.data && event.data.type === "PONG") {
        log(`ğŸ”„ SW ç‰ˆæœ¬: ${event.data.version}, ä½œç”¨åŸŸ: ${event.data.scope || '/'}`);
        updateSWStatus('registered');
      }
    });
  } catch (error) {
    console.error('è®¾ç½® SW æ¶ˆæ¯å¤„ç†å™¨å¤±è´¥:', error);
  }
}

// æ³¨å†Œ Service Workerï¼ˆä¿®å¤ç‰ˆæœ¬ï¼‰
async function registerSW() {
  if (!('serviceWorker' in navigator)) {
    log("âŒ æµè§ˆå™¨ä¸æ”¯æŒ Service Worker");
    updateSWStatus('error');
    return false;
  }
  
  try {
    updateSWStatus('installing');
    
    // è®¡ç®— Service Worker è·¯å¾„å’Œä½œç”¨åŸŸ
    const swPath = getSWPath();
    
    // å¯¹äº GitHub Pagesï¼Œä½œç”¨åŸŸå¿…é¡»æ˜¯å½“å‰ç›®å½•æˆ–å­ç›®å½•
    let scope;
    if (window.location.hostname.includes('github.io')) {
      // GitHub Pages çš„ç‰¹æ®Šå¤„ç†ï¼šä½œç”¨åŸŸå¿…é¡»æ˜¯å½“å‰ç›®å½•
      scope = './';
    } else {
      scope = BASE_PATH;
    }
    
    log(`ğŸ“¡ æ³¨å†Œ Service Worker: ${swPath}, ä½œç”¨åŸŸ: ${scope}`);
    
    const registration = await navigator.serviceWorker.register(swPath, { 
      scope: scope
    });
    
    // ç­‰å¾… Service Worker å°±ç»ª
    if (registration.installing) {
      registration.installing.addEventListener('statechange', (e) => {
        const sw = e.target;
        log(`ğŸ”„ SW çŠ¶æ€: ${sw.state}`);
        
        if (sw.state === 'activated') {
          updateSWStatus('registered');
          
          // å‘é€ ping æ£€æŸ¥è¿æ¥
          if (registration.active) {
            registration.active.postMessage({ type: "PING" });
          }
        }
      });
    } else if (registration.active) {
      updateSWStatus('registered');
      registration.active.postMessage({ type: "PING" });
    }
    
    // ç›‘å¬æ›´æ–°
    registration.addEventListener('updatefound', () => {
      const newWorker = registration.installing;
      log('ğŸ”„ å‘ç° Service Worker æ›´æ–°');
      
      newWorker.addEventListener('statechange', () => {
        log(`ğŸ”„ æ–° SW çŠ¶æ€: ${newWorker.state}`);
        if (newWorker.state === 'installed') {
          log('ğŸ”„ æ–°ç‰ˆæœ¬å·²å®‰è£…ï¼Œåˆ·æ–°é¡µé¢å³å¯ä½¿ç”¨');
        }
      });
    });
    
    return true;
  } catch (error) {
    console.error('Service Worker æ³¨å†Œå¤±è´¥:', error);
    log(`âŒ SW æ³¨å†Œå¤±è´¥: ${error.message}`);
    updateSWStatus('error');
    return false;
  }
}

// ============================
// ZIP æ–‡ä»¶å¤„ç†
// ============================
function setupZipHandler() {
  const zipInput = document.getElementById("zip");
  if (!zipInput) return;
  
  zipInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    log(`ğŸ“¦ è¯»å– ZIP æ–‡ä»¶: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
    
    // æ³¨å†Œ Service Worker
    const swRegistered = await registerSW();
    if (!swRegistered) {
      log("âŒ æ— æ³•ç»§ç»­ï¼ŒService Worker æ³¨å†Œå¤±è´¥");
      return;
    }
    
    try {
      const zip = await JSZip.loadAsync(file);
      const files = {};
      let totalSize = 0;
      let fileCount = 0;
      
      // å¤„ç†æ‰€æœ‰æ–‡ä»¶
      for (const [relativePath, entry] of Object.entries(zip.files)) {
        if (!entry.dir) {
          const cleanPath = relativePath.replace(/^\/+/, "").replace(/\\/g, "/");
          
          // è·³è¿‡ macOS çš„ __MACOSX æ–‡ä»¶å¤¹
          if (cleanPath.includes('__MACOSX/')) continue;
          
          const fileData = await entry.async("uint8array");
          files[cleanPath] = fileData;
          totalSize += fileData.length;
          fileCount++;
          
          if (fileCount <= 10) {
            log(`ğŸ“„ ${cleanPath} (${(fileData.length / 1024).toFixed(1)} KB)`);
          }
        }
      }
      
      if (fileCount > 10) {
        log(`ğŸ“„ ... ä»¥åŠå¦å¤– ${fileCount - 10} ä¸ªæ–‡ä»¶`);
      }
      
      log(`ğŸ“¤ å‡†å¤‡å‘é€ ${fileCount} ä¸ªæ–‡ä»¶ (${(totalSize / 1024 / 1024).toFixed(2)} MB)`);
      
      // æ£€æŸ¥æ˜¯å¦æœ‰å¿…è¦çš„æ–‡ä»¶
      if (!files["index.html"] && !files["www/index.html"]) {
        log("âš ï¸ è­¦å‘Š: ZIP æ–‡ä»¶ä¸­æœªæ‰¾åˆ° index.html");
      }
      
      // å‘é€æ–‡ä»¶ç»™ Service Worker
      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({ 
          type: "LOAD_GAME", 
          files: files,
          metadata: {
            fileName: file.name,
            fileCount: fileCount,
            totalSize: totalSize,
            timestamp: new Date().toISOString()
          }
        });
        
        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
        const debugInfo = getElementSafe('debug-info');
        debugInfo.innerHTML = `
          ZIP: ${file.name}<br>
          æ–‡ä»¶æ•°: ${fileCount}<br>
          æ€»å¤§å°: ${(totalSize / 1024 / 1024).toFixed(2)} MB<br>
          è·¯å¾„: ${BASE_PATH}<br>
          ç¯å¢ƒ: ${window.location.hostname.includes('github.io') ? 'GitHub Pages' : 
                 (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') ? 'æœ¬åœ°' : 'åœ¨çº¿'}
        `;
      } else {
        log("âŒ Service Worker æœªæ¿€æ´»ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
      }
    } catch (error) {
      console.error("ZIP å¤„ç†é”™è¯¯:", error);
      log(`âŒ ZIP å¤„ç†å¤±è´¥: ${error.message}`);
    }
  };
}

// ============================
// æ–‡æœ¬æå–åŠŸèƒ½
// ============================
function extractText() {
  try {
    const iframe = document.getElementById("game");
    if (!iframe) return;
    
    const gameWin = iframe.contentWindow;
    
    if (!gameWin) {
      log("âš ï¸ æ— æ³•è®¿é—®æ¸¸æˆçª—å£");
      return;
    }
    
    // å°è¯•å¤šç§ RPG Maker ç‰ˆæœ¬çš„æ¶ˆæ¯ç³»ç»Ÿ
    let text = "";
    
    // RPG Maker MZ
    if (gameWin.$gameMessage && gameWin.$gameMessage.hasText) {
      if (gameWin.$gameMessage.hasText()) {
        text = gameWin.$gameMessage._texts?.join("\n") || "";
      }
    } 
    // RPG Maker MV
    else if (gameWin.$gameMessage && gameWin.$gameMessage._texts) {
      text = gameWin.$gameMessage._texts.join("\n");
    }
    // é€šç”¨æ–¹æ³•ï¼šæŸ¥æ‰¾å¯¹è¯æ¡†å…ƒç´ 
    else {
      const messageWindows = gameWin.document.querySelectorAll('.window, .message_window');
      messageWindows.forEach(window => {
        const content = window.textContent || window.innerText;
        if (content.trim()) {
          text += content + "\n";
        }
      });
    }
    
    // æ¸…ç†æ–‡æœ¬ï¼ˆç§»é™¤æ§åˆ¶å­—ç¬¦ï¼‰
    if (text) {
      text = text.replace(/\\(?:[A-Z]+\[[^\]]*\]|[A-Z]+|[.\|\^<>!])/gi, "")
                 .replace(/\\[Nn]/g, "\n")
                 .replace(/\\[Cc]\[(\d+)\]/g, "") // ç§»é™¤é¢œè‰²ä»£ç 
                 .replace(/\{.*?\}/g, "") // ç§»é™¤å¤§æ‹¬å·å†…å®¹
                 .trim();
    }
    
    if (text && text !== lastText) {
      const textarea = getElementSafe('game-text');
      textarea.value = text;
      lastText = text;
      
      // è§†è§‰åé¦ˆ
      textarea.style.background = "#2a2a2a";
      setTimeout(() => textarea.style.background = "#1e1e1e", 100);
      
      log(`ğŸ“ æå–æ–‡æœ¬: ${text.length} å­—ç¬¦`);
    }
  } catch (e) {
    console.error("æ–‡æœ¬æå–é”™è¯¯:", e);
  }
}

function clearText() {
  const textarea = getElementSafe('game-text');
  textarea.value = "";
  lastText = "";
  log("ğŸ—‘ï¸ å·²æ¸…ç©ºæ–‡æœ¬æ¡†");
}

function startTextWatcher() {
  if (textInterval) clearInterval(textInterval);
  
  textInterval = setInterval(() => {
    const autoSync = document.getElementById("auto-sync");
    if (autoSync && autoSync.checked) {
      extractText();
    }
  }, 300);
}

// ============================
// æˆªå›¾åŠŸèƒ½
// ============================
function takeScreenshot() {
  try {
    const iframe = document.getElementById("game");
    if (!iframe) {
      log("âŒ æœªæ‰¾åˆ°æ¸¸æˆ iframe");
      return;
    }
    
    const gameWin = iframe.contentWindow;
    
    if (!gameWin) {
      log("âŒ æ— æ³•è®¿é—®æ¸¸æˆçª—å£");
      return;
    }
    
    const canvas = gameWin.document.querySelector("canvas");
    
    if (!canvas) {
      log("âŒ æœªæ‰¾åˆ°æ¸¸æˆ Canvas");
      return;
    }
    
    // æ£€æŸ¥ Canvas å°ºå¯¸
    if (canvas.width === 0 || canvas.height === 0) {
      log("âš ï¸ Canvas å°ºå¯¸ä¸º 0ï¼Œç­‰å¾…æ¸¸æˆåˆå§‹åŒ–...");
      return;
    }
    
    log(`ğŸ“· æˆªå›¾å°ºå¯¸: ${canvas.width}x${canvas.height}`);
    
    // è§†è§‰åé¦ˆï¼šé—ªå…‰æ•ˆæœ
    const flash = document.getElementById("flash");
    if (flash) {
      flash.style.opacity = "0.7";
      setTimeout(() => flash.style.opacity = "0", 150);
    }
    
    // åˆ›å»ºé«˜è´¨é‡æˆªå›¾
    const offscreenCanvas = document.createElement('canvas');
    offscreenCanvas.width = canvas.width;
    offscreenCanvas.height = canvas.height;
    const ctx = offscreenCanvas.getContext('2d');
    
    if (!ctx) {
      log("âŒ æ— æ³•åˆ›å»ºç»˜å›¾ä¸Šä¸‹æ–‡");
      return;
    }
    
    // è®¾ç½®é«˜è´¨é‡æ¸²æŸ“
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    
    // ç»˜åˆ¶æˆªå›¾
    ctx.drawImage(canvas, 0, 0);
    
    // ç”Ÿæˆæ•°æ® URL
    currentScreenshot = offscreenCanvas.toDataURL("image/png", 1.0);
    
    // æ˜¾ç¤ºæˆªå›¾
    const img = document.getElementById("screenshot-img");
    if (img) {
      img.src = currentScreenshot;
      img.style.display = "block";
      img.style.maxHeight = "200px";
    }
    
    // æ˜¾ç¤ºæç¤º
    const tip = document.getElementById("screenshot-tip");
    if (tip) {
      tip.style.display = "block";
    }
    
    // å¯ç”¨ä¸‹è½½æŒ‰é’®
    const downloadBtn = getElementSafe('download-btn');
    downloadBtn.disabled = false;
    downloadBtn.style.background = "#4CAF50";
    
    log("âœ… æˆªå›¾æˆåŠŸ");
  } catch (e) {
    console.error("æˆªå›¾å¤±è´¥:", e);
    log(`âŒ æˆªå›¾å¤±è´¥: ${e.message}`);
  }
}

function downloadScreenshot() {
  if (!currentScreenshot) {
    log("âŒ æ²¡æœ‰å¯ä¸‹è½½çš„æˆªå›¾");
    return;
  }
  
  try {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
    const filename = `screenshot-${timestamp}.png`;
    
    const link = document.createElement('a');
    link.download = filename;
    link.href = currentScreenshot;
    link.click();
    
    log(`â¬‡ï¸ ä¸‹è½½æˆªå›¾: ${filename}`);
  } catch (e) {
    console.error("ä¸‹è½½å¤±è´¥:", e);
    log(`âŒ ä¸‹è½½å¤±è´¥: ${e.message}`);
  }
}

// ============================
// åˆå§‹åŒ–
// ============================
function init() {
  try {
    // åˆå§‹åŒ– DOM å…ƒç´ å¼•ç”¨
    initDOMElements();
    
    log("ğŸš€ RPGMZ Player Pro å·²å¯åŠ¨");
    
    const isGitHubPages = window.location.hostname.includes('github.io');
    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    
    log(`ğŸŒ ç¯å¢ƒ: ${isGitHubPages ? 'GitHub Pages' : isLocalhost ? 'æœ¬åœ°' : 'åœ¨çº¿'}`);
    log(`ğŸ“ åŸºç¡€è·¯å¾„: ${BASE_PATH}`);
    
    // è®¾ç½®äº‹ä»¶å¤„ç†å™¨
    setupSWMessageHandler();
    setupZipHandler();
    
    // è‡ªåŠ¨æ³¨å†Œ Service Workerï¼ˆå¦‚æœå¯èƒ½ï¼‰
    if (window.location.protocol === 'https:' || isLocalhost) {
      setTimeout(() => {
        registerSW().then(registered => {
          if (!registered) {
            log("â„¹ï¸ Service Worker éœ€è¦ HTTPS æˆ– localhost ç¯å¢ƒ");
          }
        });
      }, 1000);
    }
    
    // åˆå§‹çŠ¶æ€
    updateSWStatus('default');
    updateGameStatus('default');
  } catch (error) {
    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
    log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
  }
}

// åœ¨ DOM å®Œå…¨åŠ è½½ååˆå§‹åŒ–
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

// å¯¼å‡ºåŠŸèƒ½ç»™å…¨å±€ä½¿ç”¨
window.extractText = extractText;
window.clearText = clearText;
window.takeScreenshot = takeScreenshot;
window.downloadScreenshot = downloadScreenshot;
</script>
</body>
</html>