<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>RPGMZ Player (GitHub Pages Compatible)</title>
  <style>
    body { font-family: "Segoe UI", sans-serif; background: #1e1e1e; color: #eee; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    header { padding: 10px 20px; background: #252526; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 15px; }
    .container { display: flex; flex: 1; height: calc(100vh - 60px); }
    .game-area { flex: 3; background: #000; display: flex; justify-content: center; align-items: center; position: relative; }
    iframe { width: 100%; height: 100%; border: none; }
    .sidebar { flex: 1; min-width: 300px; max-width: 400px; background: #252526; border-left: 1px solid #333; display: flex; flex-direction: column; padding: 15px; gap: 15px; overflow-y: auto; }
    .panel { background: #333; padding: 10px; border-radius: 5px; }
    .panel h3 { margin-top: 0; font-size: 14px; color: #aaa; text-transform: uppercase; }
    textarea#game-text { width: 100%; height: 150px; background: #1e1e1e; color: #fff; border: 1px solid #444; padding: 8px; font-size: 14px; resize: vertical; box-sizing: border-box; }
    #screenshot-img { max-width: 100%; border: 1px solid #555; display: none; margin-top: 5px; }
    button { background: #0e639c; color: white; border: none; padding: 8px 12px; cursor: pointer; border-radius: 3px; }
    button:hover { background: #1177bb; }
    button.secondary { background: #444; }
    #log { font-family: monospace; font-size: 12px; color: #888; margin-top: auto; white-space: pre-wrap; min-height: 100px; }
    #flash { position: absolute; top:0; left:0; width:100%; height:100%; background:white; opacity:0; pointer-events:none; transition: opacity 0.2s; }
    .save-manager button { width: 100%; margin-bottom: 5px; }
    #load-file-input { display: none; }
  </style>
</head>
<body>

<header>
  <h3>RPGMZ Player</h3>
  <input type="file" id="zip" accept=".zip" />
</header>

<div class="container">
  <div class="game-area">
    <iframe id="game"></iframe>
    <div id="flash"></div>
  </div>

  <div class="sidebar">
    
    <div class="panel save-manager">
      <h3>ğŸ’¾ å­˜æ¡£ç®¡ç†</h3>
      <button onclick="exportSaveFile()">å¯¼å‡ºå½“å‰å­˜æ¡£ (ä¸‹è½½)</button>
      <button onclick="document.getElementById('load-file-input').click()">è½½å…¥å­˜æ¡£ (ä¸Šä¼ )</button>
      <input type="file" id="load-file-input" accept=".json" onchange="loadSaveFile(event)">
      <p style="font-size:11px; color:#aaa; margin-top:10px;">æ³¨æ„: è½½å…¥å­˜æ¡£åéœ€åœ¨æ¸¸æˆä¸­åˆ·æ–°æ ‡é¢˜ç•Œé¢æˆ–åŠ è½½æ¸¸æˆã€‚</p>
    </div>

    <div class="panel">
      <h3>ğŸ’¬ å¯¹è¯æ–‡æœ¬æå–</h3>
      <div style="margin-bottom: 5px; display: flex; align-items: center; gap: 10px;">
        <label><input type="checkbox" id="auto-sync" checked> è‡ªåŠ¨åŒæ­¥</label>
        <button class="secondary" onclick="extractText()">æ‰‹åŠ¨æå–</button>
      </div>
      <textarea id="game-text" placeholder="å½“å‰æ²¡æœ‰å¯¹è¯..."></textarea>
    </div>

    <div class="panel">
      <h3>ğŸ“· æˆªå›¾</h3>
      <button onclick="takeScreenshot()">æˆªå–å½“å‰ç”»é¢</button>
      <img id="screenshot-img" />
      <p id="screenshot-tip" style="font-size:12px; color:#888; display:none;">å·²æ•è· (å³é”®å¯ä¿å­˜)</p>
    </div>

    <div id="log">ç­‰å¾… ZIP ä¸Šä¼ ...</div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
const log = (t) => {
  const el = document.getElementById("log");
  el.textContent = t + "\n" + el.textContent;
};

// ======================================
// â­ GitHub Pages è·¯å¾„å…¼å®¹é€»è¾‘
// ======================================

// ã€æ–°å¢å‡½æ•°ã€‘è·å–é¡¹ç›®åœ¨ GitHub Pages ä¸Šçš„å­è·¯å¾„ (ä¾‹å¦‚ï¼š/repo-name/)
function getBasePath() {
    const path = window.location.pathname; 
    return path.substring(0, path.lastIndexOf('/') + 1);
}

// ä¿®æ­£åçš„ Service Worker æ³¨å†Œå‡½æ•°
async function registerSW() {
    const basePath = getBasePath(); 
    const swUrl = basePath + "sw.js"; 
    const swScope = basePath; // Scope å¿…é¡»ç­‰äº Base Path

    if (!navigator.serviceWorker.controller) {
        console.log(`[SW] æ³¨å†Œè·¯å¾„: ${swUrl}, Scope: ${swScope}`);
        // ä½¿ç”¨åŠ¨æ€è®¡ç®—çš„ Scope è§£å†³ GitHub Pages æ³¨å†Œå¤±è´¥é—®é¢˜
        await navigator.serviceWorker.register(swUrl, { scope: swScope }); 
        await navigator.serviceWorker.ready;
    }
    log("Service Worker å°±ç»ª");
}


// ZIP åŠ è½½å’Œæ¸¸æˆå¯åŠ¨
document.getElementById("zip").onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  log("ğŸ“¦ è¯»å– ZIP...");
  await registerSW(); // ç¡®ä¿ SW æ³¨å†ŒæˆåŠŸ

  const zip = await JSZip.loadAsync(file);
  const files = {};
  
  for (const [path, entry] of Object.entries(zip.files)) {
    if (!entry.dir) {
      files[path.replace(/^\/+/, "")] = await entry.async("uint8array");
    }
  }

  log("ğŸ“¤ å‘é€ " + Object.keys(files).length + " ä¸ªæ–‡ä»¶...");
  navigator.serviceWorker.controller.postMessage({ type: "LOAD_GAME", files });

  // å¯åŠ¨æ¸¸æˆ iframeï¼Œä½¿ç”¨ Base Path ç¡®ä¿è·¯å¾„æ­£ç¡®
  const basePath = getBasePath();
  document.getElementById("game").src = basePath + "game/index.html"; 
};

// Service Worker é€šä¿¡
navigator.serviceWorker.addEventListener("message", (event) => {
  if (event.data && event.data.type === "GAME_READY") {
    log("âœ… èµ„æºå°±ç»ªï¼Œå¯åŠ¨æ¸¸æˆ...");
    startTextWatcher();
  }
});

// ======================================
// å­˜æ¡£ã€æ–‡æœ¬æå–å’Œæˆªå›¾å‡½æ•° (åŠŸèƒ½ä»£ç )
// ======================================
const iframe = document.getElementById("game");
let lastText = "";
let textInterval;

function getSaveKeys() {
    const keys = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && (key.includes('global') || key.includes('file'))) {
            keys.push(key);
        }
    }
    return keys;
}

function exportSaveFile() {
    try {
        const saveKeys = getSaveKeys();
        if (saveKeys.length === 0) {
            log("âŒ æœªæ‰¾åˆ°ä»»ä½•å­˜æ¡£æ•°æ® (LocalStorage)ã€‚è¯·å…ˆåœ¨æ¸¸æˆä¸­å­˜æ¡£ã€‚");
            return;
        }

        const saveData = {};
        saveKeys.forEach(key => {
            const data = localStorage.getItem(key);
            if (data) {
                saveData[key] = data;
            }
        });

        const jsonContent = JSON.stringify(saveData, null, 2);
        const blob = new Blob([jsonContent], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `rpgmaker_save_${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        URL.revokeObjectURL(url);
        log(`âœ… æˆåŠŸå¯¼å‡º ${saveKeys.length} ä¸ªå­˜æ¡£é”®å€¼ã€‚`);

    } catch (e) {
        console.error("å¯¼å‡ºå­˜æ¡£å¤±è´¥:", e);
        log("âŒ å¯¼å‡ºå­˜æ¡£å¤±è´¥: " + e.message);
    }
}

function loadSaveFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    log(`ğŸ“¤ å‡†å¤‡è½½å…¥å­˜æ¡£æ–‡ä»¶: ${file.name}`);

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const jsonContent = e.target.result;
            const saveData = JSON.parse(jsonContent);
            let loadedCount = 0;

            for (const key in saveData) {
                if (key.includes('global') || key.includes('file')) {
                    localStorage.setItem(key, saveData[key]);
                    loadedCount++;
                }
            }

            if (loadedCount > 0) {
                log(`âœ… æˆåŠŸè½½å…¥ ${loadedCount} ä¸ªå­˜æ¡£é”®å€¼åˆ° LocalStorageã€‚`);
                log("âš ï¸ è¯·åœ¨æ¸¸æˆæ ‡é¢˜ç•Œé¢æˆ–èœå•ä¸­é€‰æ‹© 'åŠ è½½æ¸¸æˆ' ä»¥ç”Ÿæ•ˆã€‚");
            } else {
                log("âŒ è½½å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®æˆ–æœªåŒ…å«æœ‰æ•ˆçš„å­˜æ¡£é”®å€¼ã€‚");
            }

        } catch (e) {
            console.error("è½½å…¥å­˜æ¡£å¤±è´¥:", e);
            log("âŒ è½½å…¥å­˜æ¡£å¤±è´¥ï¼šæ–‡ä»¶è§£æé”™è¯¯æˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚");
        }
        event.target.value = '';
    };
    reader.readAsText(file);
}

function extractText() {
    try {
        const gameWin = iframe.contentWindow;
        if (!gameWin || !gameWin.$gameMessage) return;

        if (gameWin.$gameMessage.hasText()) {
            let rawTexts = gameWin.$gameMessage._texts;
            let fullText = rawTexts.join("\n").replace(/\\(?:[A-Z]+\[[^\]]*\]|[A-Z]+|[.\|\^<>!])/gi, "");
            
            if (fullText !== lastText && fullText.trim() !== "") {
                document.getElementById("game-text").value = fullText;
                lastText = fullText;
                const area = document.getElementById("game-text");
                area.style.background = "#333";
                setTimeout(() => area.style.background = "#1e1e1e", 100);
            }
        }
    } catch (e) {}
}

function startTextWatcher() {
    if (textInterval) clearInterval(textInterval);
    textInterval = setInterval(() => {
        if (document.getElementById("auto-sync").checked) extractText();
    }, 200);
}

function takeScreenshot() {
    try {
        const gameWin = iframe.contentWindow;
        const canvas = gameWin.document.querySelector("canvas");
        
        if (canvas) {
            const flash = document.getElementById("flash");
            flash.style.opacity = "0.5";
            setTimeout(() => flash.style.opacity = "0", 100);

            const dataURL = canvas.toDataURL("image/png");
            const img = document.getElementById("screenshot-img");
            img.src = dataURL;
            img.style.display = "block";
            document.getElementById("screenshot-tip").style.display = "block";
            log("ğŸ“· æˆªå›¾æˆåŠŸ");
        } else {
            log("âŒ æœªæ‰¾åˆ°æ¸¸æˆ Canvas");
        }
    } catch (e) {
        console.error(e);
        log("âŒ æˆªå›¾å¤±è´¥: " + e.message);
    }
}
</script>
</body>
</html>