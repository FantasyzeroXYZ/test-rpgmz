<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>RPGMZ Player (Pro)</title>
  <style>
    body { font-family: "Segoe UI", sans-serif; background: #1e1e1e; color: #eee; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    header { padding: 10px 20px; background: #252526; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 15px; }
    .container { display: flex; flex: 1; height: calc(100vh - 60px); }
    .game-area { flex: 3; background: #000; display: flex; justify-content: center; align-items: center; position: relative; }
    iframe { width: 100%; height: 100%; border: none; }
    .sidebar { flex: 1; min-width: 300px; max-width: 400px; background: #252526; border-left: 1px solid #333; display: flex; flex-direction: column; padding: 15px; gap: 15px; overflow-y: auto; }
    .panel { background: #333; padding: 10px; border-radius: 5px; }
    .panel h3 { margin-top: 0; font-size: 14px; color: #aaa; text-transform: uppercase; }
    textarea#game-text { width: 100%; height: 150px; background: #1e1e1e; color: #fff; border: 1px solid #444; padding: 8px; font-size: 14px; resize: vertical; box-sizing: border-box; }
    #screenshot-img { max-width: 100%; border: 1px solid #555; display: none; margin-top: 5px; }
    button { background: #0e639c; color: white; border: none; padding: 8px 12px; cursor: pointer; border-radius: 3px; }
    button:hover { background: #1177bb; }
    button.secondary { background: #444; }
    #log { font-family: monospace; font-size: 12px; color: #888; margin-top: auto; white-space: pre-wrap; min-height: 100px; }
    
    /* æˆªå›¾é—ªå…‰ç‰¹æ•ˆ */
    #flash { position: absolute; top:0; left:0; width:100%; height:100%; background:white; opacity:0; pointer-events:none; transition: opacity 0.2s; }
  </style>
</head>
<body>

<header>
  <h3>RPGMZ Player</h3>
  <input type="file" id="zip" accept=".zip" />
</header>

<div class="container">
  <div class="game-area">
    <iframe id="game"></iframe>
    <div id="flash"></div>
  </div>

  <div class="sidebar">
    <div class="panel">
      <h3>ğŸ’¬ å¯¹è¯æ–‡æœ¬æå–</h3>
      <div style="margin-bottom: 5px; display: flex; align-items: center; gap: 10px;">
        <label><input type="checkbox" id="auto-sync" checked> è‡ªåŠ¨åŒæ­¥</label>
        <button class="secondary" onclick="extractText()">æ‰‹åŠ¨æå–</button>
      </div>
      <textarea id="game-text" placeholder="å½“å‰æ²¡æœ‰å¯¹è¯..."></textarea>
    </div>

    <div class="panel">
      <h3>ğŸ“· æˆªå›¾</h3>
      <button onclick="takeScreenshot()">æˆªå–å½“å‰ç”»é¢</button>
      <img id="screenshot-img" />
      <p id="screenshot-tip" style="font-size:12px; color:#888; display:none;">å·²æ•è· (å³é”®å¯ä¿å­˜)</p>
    </div>

    <div id="log">ç­‰å¾… ZIP ä¸Šä¼ ...</div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
const log = (t) => {
  const el = document.getElementById("log");
  el.textContent = t + "\n" + el.textContent;
};

// ============================
// Service Worker æ³¨å†Œä¸é€šä¿¡
// ============================
navigator.serviceWorker.addEventListener("message", (event) => {
  if (event.data && event.data.type === "GAME_READY") {
    log("âœ… èµ„æºå°±ç»ªï¼Œå¯åŠ¨æ¸¸æˆ...");
    document.getElementById("game").src = "/game/index.html";
    startTextWatcher();
  }
});

async function registerSW() {
  if (!navigator.serviceWorker.controller) {
    await navigator.serviceWorker.register("sw.js", { scope: "/" });
    await navigator.serviceWorker.ready;
  }
}

document.getElementById("zip").onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  log("ğŸ“¦ è¯»å– ZIP...");
  await registerSW();
  const zip = await JSZip.loadAsync(file);
  const files = {};
  for (const [path, entry] of Object.entries(zip.files)) {
    if (!entry.dir) {
      files[path.replace(/^\/+/, "")] = await entry.async("uint8array");
    }
  }
  log("ğŸ“¤ å‘é€ " + Object.keys(files).length + " ä¸ªæ–‡ä»¶...");
  navigator.serviceWorker.controller.postMessage({ type: "LOAD_GAME", files });
};

// ============================
// åŠŸèƒ½å‡½æ•°
// ============================
const iframe = document.getElementById("game");
let lastText = "";
let textInterval;

function extractText() {
  try {
    const gameWin = iframe.contentWindow;
    if (!gameWin || !gameWin.$gameMessage) return;

    if (gameWin.$gameMessage.hasText()) {
      let rawTexts = gameWin.$gameMessage._texts;
      let fullText = rawTexts.join("\n").replace(/\\(?:[A-Z]+\[[^\]]*\]|[A-Z]+|[.\|\^<>!])/gi, "");
      
      if (fullText !== lastText && fullText.trim() !== "") {
        document.getElementById("game-text").value = fullText;
        lastText = fullText;
        const area = document.getElementById("game-text");
        area.style.background = "#333";
        setTimeout(() => area.style.background = "#1e1e1e", 100);
      }
    }
  } catch (e) {}
}

function startTextWatcher() {
  if (textInterval) clearInterval(textInterval);
  textInterval = setInterval(() => {
    if (document.getElementById("auto-sync").checked) extractText();
  }, 200);
}

function takeScreenshot() {
  try {
    const gameWin = iframe.contentWindow;
    const canvas = gameWin.document.querySelector("canvas");
    
    if (canvas) {
      // æ£€æŸ¥æ˜¯å¦åº”ç”¨äº†ä¿®å¤è¡¥ä¸
      const gl = canvas.getContext("webgl") || canvas.getContext("webgl2");
      if (gl) {
         const attrs = gl.getContextAttributes();
         if (!attrs.preserveDrawingBuffer) {
             log("âš ï¸ è­¦å‘Š: preserveDrawingBuffer ä¸º falseï¼Œæˆªå›¾å¯èƒ½å…¨é»‘ã€‚è¯·åˆ·æ–°é‡è¯•ã€‚");
         }
      }

      // è§†è§‰åé¦ˆï¼šé—ªå…‰
      const flash = document.getElementById("flash");
      flash.style.opacity = "0.5";
      setTimeout(() => flash.style.opacity = "0", 100);

      // æˆªå›¾
      const dataURL = canvas.toDataURL("image/png");
      const img = document.getElementById("screenshot-img");
      img.src = dataURL;
      img.style.display = "block";
      document.getElementById("screenshot-tip").style.display = "block";
      log("ğŸ“· æˆªå›¾æˆåŠŸ");
    } else {
      log("âŒ æœªæ‰¾åˆ°æ¸¸æˆ Canvas");
    }
  } catch (e) {
    console.error(e);
    log("âŒ æˆªå›¾å¤±è´¥: " + e.message);
  }
}
</script>
</body>
</html>