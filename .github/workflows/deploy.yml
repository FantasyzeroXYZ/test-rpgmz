name: Deploy to GitHub Pages

on:
  # æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
  workflow_dispatch:
  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨éƒ¨ç½²
  push:
    branches: [ "main", "master" ]
  # æ¨é€åˆ° gh-pages åˆ†æ”¯æ—¶è‡ªåŠ¨éƒ¨ç½²
  push:
    branches: [ "gh-pages" ]
  # æ¯å‘¨æ—¥è‡ªåŠ¨é‡æ–°éƒ¨ç½²ï¼ˆä¿æŒç¼“å­˜æ–°é²œï¼‰
  schedule:
    - cron: '0 2 * * 0'

# è®¾ç½® GITHUB_TOKEN çš„æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# å…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æ„å»ºä»»åŠ¡
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Create necessary files
        run: |
          # åˆ›å»º .nojekyll æ–‡ä»¶ï¼ˆé˜²æ­¢ GitHub Pages å¿½ç•¥ä¸‹åˆ’çº¿æ–‡ä»¶ï¼‰
          echo "Creating .nojekyll file..."
          touch .nojekyll
          
          # åˆ›å»º 404.html æ–‡ä»¶ï¼ˆå•é¡µåº”ç”¨è·¯ç”±æ”¯æŒï¼‰
          echo "Creating 404.html file..."
          cat > 404.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>RPGMZ Player - Page Not Found</title>
              <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ®</text></svg>">
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      background: linear-gradient(135deg, #1e1e1e 0%, #252526 100%);
                      color: #fff;
                      min-height: 100vh;
                      display: flex;
                      flex-direction: column;
                      align-items: center;
                      justify-content: center;
                      padding: 20px;
                      text-align: center;
                  }
                  
                  .container {
                      max-width: 600px;
                      width: 100%;
                      padding: 40px;
                      background: rgba(37, 37, 38, 0.9);
                      border-radius: 16px;
                      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                      border: 1px solid #333;
                  }
                  
                  h1 {
                      font-size: 120px;
                      margin-bottom: 20px;
                      color: #0e639c;
                      font-weight: 800;
                      line-height: 1;
                  }
                  
                  h2 {
                      font-size: 28px;
                      margin-bottom: 20px;
                      color: #fff;
                      font-weight: 600;
                  }
                  
                  p {
                      font-size: 16px;
                      line-height: 1.6;
                      color: #aaa;
                      margin-bottom: 30px;
                  }
                  
                  .game-icon {
                      font-size: 60px;
                      margin-bottom: 20px;
                      display: block;
                  }
                  
                  .button-group {
                      display: flex;
                      gap: 15px;
                      justify-content: center;
                      flex-wrap: wrap;
                      margin-top: 30px;
                  }
                  
                  .btn {
                      display: inline-block;
                      padding: 12px 28px;
                      background: #0e639c;
                      color: white;
                      text-decoration: none;
                      border-radius: 8px;
                      font-weight: 600;
                      font-size: 16px;
                      transition: all 0.3s ease;
                      border: none;
                      cursor: pointer;
                  }
                  
                  .btn:hover {
                      background: #1177bb;
                      transform: translateY(-2px);
                      box-shadow: 0 6px 20px rgba(14, 99, 156, 0.4);
                  }
                  
                  .btn-secondary {
                      background: #444;
                  }
                  
                  .btn-secondary:hover {
                      background: #555;
                  }
                  
                  .spinner {
                      display: inline-block;
                      width: 20px;
                      height: 20px;
                      border: 3px solid rgba(255, 255, 255, 0.3);
                      border-radius: 50%;
                      border-top-color: #0e639c;
                      animation: spin 1s ease-in-out infinite;
                      margin-right: 10px;
                  }
                  
                  @keyframes spin {
                      to { transform: rotate(360deg); }
                  }
                  
                  .redirect-text {
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      margin-top: 30px;
                      color: #888;
                      font-size: 14px;
                  }
                  
                  @media (max-width: 768px) {
                      .container {
                          padding: 30px 20px;
                      }
                      
                      h1 {
                          font-size: 80px;
                      }
                      
                      h2 {
                          font-size: 24px;
                      }
                      
                      .button-group {
                          flex-direction: column;
                          align-items: center;
                      }
                      
                      .btn {
                          width: 100%;
                          max-width: 300px;
                      }
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <span class="game-icon">ğŸ®</span>
                  <h1>404</h1>
                  <h2>Page Not Found</h2>
                  <p>The page you're looking for doesn't exist or has been moved. This is a single-page application, so you'll be redirected to the main page.</p>
                  
                  <div class="button-group">
                      <a href="/" class="btn">Go to Homepage</a>
                      <a href="javascript:history.back()" class="btn btn-secondary">Go Back</a>
                  </div>
                  
                  <div class="redirect-text">
                      <div class="spinner"></div>
                      <span>Redirecting to homepage...</span>
                  </div>
              </div>
              
              <script>
                  // é‡å®šå‘é€»è¾‘
                  (function() {
                      // ä¿å­˜å½“å‰è·¯å¾„ä»¥ä¾¿é‡å®šå‘åæ¢å¤
                      const redirect = sessionStorage.redirect;
                      const timestamp = sessionStorage.redirectTime;
                      const now = Date.now();
                      
                      // å¦‚æœé‡å®šå‘åœ¨ 5 åˆ†é’Ÿå†…å‘ç”Ÿï¼Œä½¿ç”¨ä¿å­˜çš„è·¯å¾„
                      if (redirect && timestamp && (now - parseInt(timestamp)) < 5 * 60 * 1000) {
                          delete sessionStorage.redirect;
                          delete sessionStorage.redirectTime;
                          
                          // æ¸…ç†è·¯å¾„
                          const cleanRedirect = redirect.replace(/\/\/+/g, '/');
                          if (cleanRedirect !== location.pathname) {
                              console.log('Redirecting to:', cleanRedirect);
                              history.replaceState(null, null, cleanRedirect);
                              location.reload();
                              return;
                          }
                      }
                      
                      // å¦åˆ™é‡å®šå‘åˆ°ä¸»é¡µ
                      console.log('Redirecting to homepage...');
                      
                      // æ˜¾ç¤ºå€’è®¡æ—¶
                      let countdown = 3;
                      const redirectText = document.querySelector('.redirect-text span');
                      const interval = setInterval(() => {
                          if (countdown <= 0) {
                              clearInterval(interval);
                              if (location.pathname === '/') {
                                  location.reload();
                              } else {
                                  location.replace('/');
                              }
                          } else {
                              redirectText.textContent = `Redirecting to homepage in ${countdown} seconds...`;
                              countdown--;
                          }
                      }, 1000);
                      
                      // 3 ç§’åè‡ªåŠ¨é‡å®šå‘
                      setTimeout(() => {
                          if (location.pathname === '/') {
                              location.reload();
                          } else {
                              location.replace('/');
                          }
                      }, 3000);
                  })();
                  
                  // ä¿å­˜å½“å‰è·¯å¾„åˆ° sessionStorageï¼ˆä¾›é‡å®šå‘åä½¿ç”¨ï¼‰
                  if (location.pathname !== '/') {
                      sessionStorage.redirect = location.pathname;
                      sessionStorage.redirectTime = Date.now();
                  }
              </script>
          </body>
          </html>
          EOF
          
          # åˆ›å»º CNAME æ–‡ä»¶ï¼ˆå¦‚æœé…ç½®äº†è‡ªå®šä¹‰åŸŸåï¼‰
          if [ -n "${{ vars.CUSTOM_DOMAIN }}" ]; then
            echo "${{ vars.CUSTOM_DOMAIN }}" > CNAME
          fi
          
          # éªŒè¯å¿…è¦æ–‡ä»¶å­˜åœ¨
          echo "Verifying required files..."
          ls -la index.html sw.js 404.html .nojekyll
          
          # è¾“å‡ºæ–‡ä»¶ä¿¡æ¯
          echo "File sizes:"
          du -h index.html sw.js 404.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

  # éƒ¨ç½²ä»»åŠ¡
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4